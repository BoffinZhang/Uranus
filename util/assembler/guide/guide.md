# 我是一个标题

以下是关于 `assembler` 这个工具的情况。

## UML 图

没有 UML 图。

## 目前实现的部分

目前已经实现了系统能力培养大赛要求的所有汇编指令的生成功能。并且支持伪指令 `li`、`la`、`move` 和 `nop`，以及在跳转和分支指令中书写标签（避免人工求偏移量）。

指令相关的常量定义参考 [mipsdef.py](../mipsdef.py)；用于处理指令生成的类（`_InstBuilder` 和它的一堆子类）参考 [mipsinst.py](../mipsinst.py)，这里用了简单的设计模式但是我也懒得查这种模式叫什么名字了，一些地方写的很乱；用于生成汇编的类（`AsmGenerator` 类）参考 [asmgen.py](../asmgen.py)。

## 待实现和需要改写的部分

为了方便使用 `Block Memory Generator`（是叫这个名字吗？）这个 IP 核生成 RAM 和 ROM，汇编器应当支持输出 `coe` 格式的文件以便于 RAM 和 ROM 加载。并且，汇编器应当支持在汇编（`*.s`）文件中定义数据段和代码段，在数据段中可以使用 `.asciiz` 或者 `.word` 等助记符写入字符串或者四字节整数等数据。在生成过程中，分别将数据段和代码段的内容输出到两个 `coe` 文件中，以便 RAM 和 ROM 加载以及上板验证。

目前的汇编器只能生成用于在仿真时使用 `$readmemh` 读取的数据文件，我们暂且称之为十六进制文本文件。基于这个设计，指令生成类的 `build` 方法会返回一个用空格分隔的十六进制字符串，并且 `AsmGenerator` 的 `generate` 方法同样会返回一个字符串。

为了支持区分数据段和代码段，新建一个段管理器类（`SegmentManager`，[asmgen.py](../asmgen.py)）用来管理分段。段管理器中保存生成过程中数据段和代码段的具体内容，可以看到段管理器中目前有两个 `list`，分别用来保存 RAM 和 ROM 的数据。

之前的实现中，代码段的数据全部保存在 `AsmGenerator` 中。于是现在需要重写 `AsmGenerator` 类的 `__append` 和 `__get_pos` 方法使其支持和 `SegmentManager` 类进行交互，将数据放入代码段中，或者正确地“获取位置”——这里的位置用来计算标签的偏移量，所以“获取位置”返回的值是目前存储的指令的总条数。除此之外，`AsmGenerator` 还需要正确处理数据段和代码段的定义，将对应段的内容合理存放。

这样的话，之前实现的 `_InstBuilder` 类中，`build` 方法返回十六进制字符串的做法就显得有些不妥了。目前的设想是，此方法应当返回一个 byte list（也就是一个包含了四个不超过 255 的 `int` 的 `list`），这样就能方便我们在之后的生成阶段中将数据输出到不同类型的文件当中。所有子类的 `build` 方法均会调用父类中的静态方法 `_get_byte`，理论上我们只需要重写此方法即可。

为了处理文件的生成，在 [converter.py](../converter.py) 中我们定义了 `_Converter` 类（和它的子类），这些类的作用是将 byte list（或者 `bytes`）转换为对应格式的文件。这一部分还没有写完，代码中只写了一些粗略的实现，其具体实现应当根据实际情况进行进一步考量。

`_Converter` 类有三个子类，分别用于生成 `coe` 文件、十六进制的文本文件和二进制文件。生成二进制文件其实不是重点，但是可以顺便写一下。此部分完成之后，`AsmGenerator` 的 `generate` 方法可以根据参数，使用不同的 `_Converter` 来生成不同种类的文件。

最后，程序的入口定义在了 [mips_asm.py](../mips_asm.py) 中。这部分的功能是解析命令行参数，然后根据给定的参数进行相应的输出。由于现在程序支持的参数变得很复杂了，我们可以使用 Python 内建的 `argparse` 类来解析命令行参数。

## 示例文件

一个看起来比较正常的汇编文件如 [a_plus_b.s](a_plus_b.s) 所示。在汇编中，我们可以使用 `.data` 和 `.text` 区分数据段和代码段，或者如果没有写这些标记的话，默认只生成代码段。而且不能只写 `.data`。

简单起见，我们规定，如果要写 `.data` 的话，必须写在 `.text` 之前。而且在一个汇编文件中，只能出现一次 `.text` 和 `.data`。

从一些汇编器生成的二进制文件来看，`.text` 段中的标签会被映射到从 `0x10010000` 开始的虚地址。也就是说，示例文件中的 `prompt_a` 标签对应的值是 `0x10010000`，`prompt_b` 对应的值是 `0x1001000a`。所以我们应当在 `SegmentManager` 或者 `AsmGenerator` 中控制 `.text` 段中所有标签的地址映射。

当然不这么做应该也行。

还有就是，系统能力培养大赛的 MIPS 规范中要求，PC 寄存器初始化的值应当为 `0xbfc00000`。这样的话，**所有跳转（jump）指令的偏移量似乎也需要进行修改**。这部分挺重要的。

## 附

1. Python 代码应当尽量遵循以下命名规范：[一个链接](http://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/python_style_rules/#id16)。
2. 感觉这个轮子造得似乎毫无意义的样子 = =
